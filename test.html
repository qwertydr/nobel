<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IARCO 2025 — Certificate Generator (A4)</title>

  <!-- Google Fonts to match certificate styling -->
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital@0;1&family=Playfair+Display:ital,wght@0,400;0,700;1,700&family=Great+Vibes&display=swap" rel="stylesheet">

  <!-- libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#f3f3f0;
      --panel:#ffffff;
      --accent:#0b3b66;
      --gold:#d6b24b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Lora", serif;
      background: linear-gradient(180deg,#eef3f8,#f6f6f4);
      color:#222;
      display:flex;
      justify-content:center;
      padding:22px;
    }
    .wrap{
      width:100%;
      max-width:1200px;
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:18px;
      align-items:start;
    }

    .panel{
      background:var(--panel);
      border-radius:12px;
      padding:18px;
      box-shadow:0 12px 30px rgba(11,59,102,0.08);
      border:1px solid rgba(11,59,102,0.04);
    }

    header{display:flex;align-items:center;justify-content:space-between; gap:12px; margin-bottom:12px}
    .title{display:flex; gap:12px; align-items:center}
    .logo{
      width:60px;height:60px;border-radius:8px;background:linear-gradient(135deg,var(--gold),#f0d06e);display:flex;align-items:center;justify-content:center;font-weight:800;color:#08324a;font-size:20px;
    }
    h1{margin:0;font-family:"Playfair Display", serif;font-size:18px;color:var(--accent)}
    .controls{display:flex;gap:8px;align-items:center}
    input[type="search"]{padding:10px 12px;border-radius:8px;border:1px solid rgba(11,59,102,0.06);min-width:260px}
    button{padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:white;font-weight:700;cursor:pointer}
    button.secondary{background:transparent;color:var(--accent);border:1px solid rgba(11,59,102,0.08)}

    /* results list */
    #results{margin-top:8px;display:flex;flex-direction:column;gap:8px}
    .student-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:linear-gradient(180deg,#fff,#fbfbfa);box-shadow:0 6px 14px rgba(11,59,102,0.04)}
    .student-left{display:flex;gap:10px;align-items:center}
    .avatar{width:48px;height:48px;border-radius:8px;background:linear-gradient(180deg,#fff,#f4f4f0);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent)}
    .student-meta{font-size:14px}
    .student-meta .name{font-weight:800;color:var(--accent);font-family:"Playfair Display", serif}
    .student-meta .small{font-size:13px;color:#556;margin-top:4px}

    /* preview area */
    .preview-area{display:flex;flex-direction:column;gap:10px}
    .preview-box{
      width:100%;
      border-radius:8px;
      overflow:hidden;
      background:linear-gradient(180deg,#fff,#fbfbfa);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:14px;
      justify-content:center;
      min-height:720px;
    }

    /* canvas container (responsive) */
    .canvas-wrap{
      width:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      background:#eee;
      padding:10px;
      border-radius:6px;
    }
    #a4preview{
      width:100%;
      max-width:720px; /* scaled preview */
      height:auto;
      border:1px solid rgba(11,59,102,0.06);
      box-shadow:0 10px 30px rgba(11,59,102,0.06);
      display:block;
    }

    /* right column meta */
    .meta{display:flex;flex-direction:column;gap:8px;padding:12px}
    .meta h3{margin:0;color:var(--accent);font-family:"Playfair Display", serif}
    .meta p{margin:0;font-size:14px;color:#333}
    .meta .small{font-size:13px;color:#556}
    .help{font-size:13px;color:#666;padding-top:6px}

    /* overlay generating */
    .overlay{
      position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(2,18,33,0.46);display:flex;align-items:center;justify-content:center;z-index:9999;visibility:hidden;opacity:0;transition:all .18s ease;
    }
    .overlay.show{visibility:visible;opacity:1}
    .genbox{
      background:linear-gradient(180deg,#fff,#fbfbfa);padding:22px;border-radius:12px;box-shadow:0 28px 60px rgba(2,18,33,0.28);text-align:center;width:360px;
    }
    .progress{height:10px;background:rgba(11,59,102,.06);border-radius:999px;overflow:hidden;margin-top:14px}
    .progress .bar{height:100%;width:0;background:linear-gradient(90deg,var(--gold),#f0c85b);transition:width 0.8s ease}

    footer{margin-top:10px;font-size:13px;color:#666}

    /* responsive adjustments */
    @media (max-width:980px){
      .wrap{grid-template-columns:1fr}
      .meta{order:2}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <header>
        <div class="title">
          <div class="logo">IARCO</div>
          <div>
            <h1>IARCO — Certificate Generator 2025</h1>
            <div style="font-size:13px;color:#556">Gold & Blue theme — A4 template-based</div>
          </div>
        </div>
        <div class="controls">
          <input id="search" placeholder="Search student name (press Enter)" />
          <button id="btnLoad" class="secondary">Load All</button>
        </div>
      </header>

      <div id="results"></div>

      <div style="margin-top:14px" class="help">
        <strong>Tip:</strong> Serve via HTTP (e.g., <code>python -m http.server</code>) for local PDF/image access.
      </div>
    </div>

    <aside class="panel meta">
      <h3>Preview & Options</h3>
      <p id="metaName">No student selected</p>
      <p class="small" id="metaDesc">Search and select a student to generate a certificate. Ranks are computed using <code>scaledFinalScore</code>.</p>
      <div style="margin-top:10px">
        <button id="downloadLast">Download Last Generated</button>
      </div>
      <hr/>
      <p class="small"><strong>Template:</strong> 2025.png (A4 2480×3508)</p>
      <p class="small"><strong>Output:</strong> A4 PDF</p>
    </aside>

    <div class="preview-box panel" style="grid-column:1 / -1">
      <h3 style="margin:0 0 10px 0;font-family:'Playfair Display', serif;color:var(--accent)">Certificate Preview</h3>
      <div class="canvas-wrap">
        <!-- large hidden canvas sized at full A4 px (2480x3508) - we will scale for preview -->
        <canvas id="a4canvas" width="2480" height="3508" style="display:none"></canvas>
        <!-- preview image to show scaled canvas -->
        <img id="a4preview" alt="Certificate preview will appear here" src="" />
      </div>
      <footer>Search a student and press Generate. The certificate will be prepared at full A4 resolution and downloaded as PDF.</footer>
    </div>
  </div>

  <!-- overlay -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="genbox">
      <div style="font-family:'Playfair Display', serif;font-weight:700;font-size:20px;color:var(--accent)">Generating certificate...</div>
      <div style="margin-top:8px;color:#444">Preparing high-resolution A4 PDF</div>
      <div class="progress"><div id="bar" class="bar"></div></div>
    </div>
  </div>

  <script>
  (function(){
    // -------------------------
    // Embedded data (demo). Replace with fetch() if you want external JSON files.
    // -------------------------
    const students = [
      {
        "student_id":"v1MrV4dT",
        "name":"Afia Anjum Aboni",
        "school":"Rajuk Uttara Model College",
        "class":"A Level",
        "category":"Junior",
        "year":2024,
        "country":"Bangladesh",
        "research_proposal_title":"The Relevance of Class Disparity in the Implementation of Climate-Related Policies; an Investigation into the Different Socioeconomic Classes of Dhaka",
        "researchPaperScore":78,
        "presentationScore":68,
        "submissionScore":146,
        "scaledFinalScore":131,
        "viewProposal":"https://drive.google.com/open?id=1aBuuRXyiIBx-908Tujbzt2vXRqBq_rzX"
      },
      {
        "student_id":"LXd6a9ey",
        "name":"Adira Safwan",
        "school":"Maple Leaf International School",
        "class":"Grade 12",
        "category":"Senior",
        "year":2024,
        "country":"Bangladesh",
        "research_proposal_title":"Exploring Differences in Social Media Literacy Between Digital Natives and Digital Immigrants: A Comparative Analysis of Critical Skills and Digital Adaptability",
        "researchPaperScore":69,
        "presentationScore":85,
        "submissionScore":154,
        "scaledFinalScore":154,
        "viewProposal":"https://iarco.org/storage/2024/junior/research_proposal/02_Adira_RP_Junior_IARCO_2024.pdf"
      },
      {"student_id":"s3","name":"Sample One","school":"X Academy","class":"10","category":"Junior","year":2024,"country":"Japan","researchPaperScore":80,"presentationScore":90,"submissionScore":170,"scaledFinalScore":170},
      {"student_id":"s4","name":"Sample Two","school":"Y High School","class":"11","category":"Junior","year":2024,"country":"Canada","researchPaperScore":50,"presentationScore":60,"submissionScore":110,"scaledFinalScore":110},
      {"student_id":"s5","name":"Sarhan Alam Khan","school":"Scholastica","class":"A Level","category":"Junior","year":2024,"country":"Bangladesh","research_proposal_title":"Enhancing IoT Security with Machine Learning for Real-Time Threat Detection","researchPaperScore":70,"presentationScore":64,"submissionScore":134,"scaledFinalScore":134}
    ];

    const flags = {
      "Japan": "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 12' width='240' height='144'><rect width='20' height='12' fill='#ffffff'/><circle cx='10' cy='6' r='3.6' fill='#bc002d'/></svg>",
      "Canada":"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 12' width='240' height='144'><rect width='20' height='12' fill='#ff0000'/><rect x='6' width='8' height='12' fill='#ffffff'/><path fill='#ff0000' d='M10 2.2 8.8 3.5h0.7v1.8h0.9V3.5h0.7L10 2.2zm0 6.6-1.4-2.1h0.9v-1h0.9v1h0.9L10 8.8z'/></svg>",
      "Bangladesh":"<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 12' width='240' height='144'><rect width='20' height='12' fill='#006a4e'/><circle cx='8.6' cy='6' r='3.2' fill='#f42b20'/></svg>"
    };

    const medals = {
      "gold": `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 80' width='240' height='240'><defs><linearGradient id='g1' x1='0' x2='1'><stop offset='0' stop-color='#ffd54a'/><stop offset='1' stop-color='#d4a017'/></linearGradient></defs><circle cx='40' cy='30' r='24' fill='url(#g1)' stroke='#b58300' stroke-width='2'/><path d='M32 44 L28 72 L40 60 L52 72 L48 44' fill='#d4a017' stroke='#b58300'/></svg>`,
      "silver": `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 80' width='240' height='240'><circle cx='40' cy='30' r='24' fill='#cfcfcf' stroke='#9b9b9b' stroke-width='2'/><path d='M32 44 L28 72 L40 60 L52 72 L48 44' fill='#bdbdbd' stroke='#9b9b9b'/></svg>`,
      "bronze": `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 80' width='240' height='240'><circle cx='40' cy='30' r='24' fill='#d2a679' stroke='#a06a3c' stroke-width='2'/><path d='M32 44 L28 72 L40 60 L52 72 L48 44' fill='#b68149' stroke='#a06a3c'/></svg>`,
      "honorable": `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 80' width='240' height='240'><circle cx='40' cy='30' r='24' fill='#e6f4ff' stroke='#6fa8dd' stroke-width='2'/><text x='40' y='36' font-size='10' text-anchor='middle' fill='#0b3b66'>HM</text></svg>`,
      "finalist": `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 80' width='240' height='240'><circle cx='40' cy='30' r='24' fill='#eef7ea' stroke='#6fbf73' stroke-width='2'/><text x='40' y='36' font-size='10' text-anchor='middle' fill='#2d6b2d'>F</text></svg>`
    };

    // constants for canvas
    const CANVAS_W = 2480; // A4 width px (approx for 300dpi-like quality)
    const CANVAS_H = 3508; // A4 height px

    // DOM elements
    const elSearch = document.getElementById('search');
    const elResults = document.getElementById('results');
    const elLoad = document.getElementById('btnLoad');
    const elPreview = document.getElementById('a4preview');
    const canvas = document.getElementById('a4canvas');
    const ctx = canvas.getContext('2d');
    const overlay = document.getElementById('overlay');
    const bar = document.getElementById('bar');
    const metaName = document.getElementById('metaName');
    const downloadLastBtn = document.getElementById('downloadLast');

    let lastBlobURL = null; // last generated PDF blob
    let lastStudent = null;

    // -------------------------
    // Ranking algorithm you provided
    // -------------------------
    function calculateRanks(studentsList) {
      // clone to not mutate original when sorting outside
      const arr = [...studentsList];
      arr.sort((a, b) => (b.scaledFinalScore || 0) - (a.scaledFinalScore || 0));
      arr.forEach((student, index) => {
        student.rank = index + 1;
      });
      return arr;
    }

    // Helper: find student by name fuzzy
    function findMatches(q){
      const qn = (q||'').trim().toLowerCase();
      if(!qn) return [];
      return students.filter(s => s.name.toLowerCase().includes(qn));
    }

    // render list
    function renderResults(list){
      elResults.innerHTML = '';
      if(!list.length){
        elResults.innerHTML = '<div style="padding:12px;color:#667">No results</div>';
        return;
      }
      // compute ranks across dataset (year/category may vary; you can adapt to compute per category)
      const ranked = calculateRanks(students);

      list.forEach(s=>{
        const row = document.createElement('div');
        row.className = 'student-row';
        const left = document.createElement('div');
        left.className = 'student-left';
        const av = document.createElement('div');
        av.className = 'avatar';
        av.textContent = s.name.split(' ').slice(0,2).map(n=>n[0]).join('');
        const meta = document.createElement('div');
        meta.className = 'student-meta';
        const name = document.createElement('div'); name.className = 'name'; name.textContent = s.name;
        const small = document.createElement('div'); small.className = 'small'; small.textContent = `${s.school} · ${s.class || ''} · score: ${s.scaledFinalScore || (s.researchPaperScore + s.presentationScore)}`;
        meta.appendChild(name); meta.appendChild(small);
        left.appendChild(av); left.appendChild(meta);

        const right = document.createElement('div');
        const gen = document.createElement('button');
        gen.textContent = 'Generate';
        gen.style.background = 'linear-gradient(90deg,var(--gold),#f0c85b)';
        gen.style.color = '#072b4a';
        gen.addEventListener('click', ()=> startGenerate(s));
        right.appendChild(gen);

        row.appendChild(left); row.appendChild(right);
        elResults.appendChild(row);
      });
    }

    // initial empty
    renderResults([]);

    elLoad.addEventListener('click', ()=> renderResults(students));

    elSearch.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        renderResults(findMatches(elSearch.value));
      }
    });

    // Main generate flow
    async function startGenerate(student){
      lastStudent = student;
      metaName.textContent = `${student.name} — ${student.school}`;
      // compute ranks using algorithm across whole dataset
      const ranked = calculateRanks(students);
      // find this student's rank object (we need to use student identity)
      const found = ranked.find(s=>s.student_id === student.student_id || s.name === student.name);
      const rank = found ? found.rank : (student.rank || 'N/A');
      const totalParticipants = ranked.length;

      // determine medal type
      function medalForRank(r){
        if(r===1) return 'gold';
        if(r===2) return 'silver';
        if(r===3) return 'bronze';
        if(r>=4 && r<=10) return 'honorable';
        return 'finalist';
      }
      const medalKey = medalForRank(rank);

      // overlay UI
      showOverlay();

      try{
        // 1. load background image (A4)
        const bg = await loadImage('./2025.png'); // ensure image exists in same folder
        // 2. draw everything on canvas (full resolution)
        drawCertificateCanvas(ctx, bg, {
          student,
          rank,
          totalParticipants,
          medalSvg: medals[medalKey],
          flagSvg: flags[student.country] || null,
          certId: makeCertificationId(student.year || 2025, student.category || 'GEN', rank),
          dateStr: (new Date()).toLocaleDateString()
        });

        // 3. preview scaled
        elPreview.src = canvas.toDataURL('image/png');

        // 4. generate PDF from canvas and auto download
        await canvasToPdfAndDownload(canvas, `${student.name.replace(/\s+/g,'_')}_IARCO_${student.year || 2025}.pdf`);

      } catch(err){
        console.error(err);
        alert('Error generating certificate: ' + (err.message || err));
      } finally {
        hideOverlay();
      }
    }

    // helper to load image into Image obj
    function loadImage(src){
      return new Promise((res,rej)=>{
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = ()=>res(img);
        img.onerror = (e)=> rej(new Error('Failed loading image: '+src));
        img.src = src;
      });
    }

    // helper to create cert id
    function makeCertificationId(year, category, rank){
      const tsShort = Date.now().toString().slice(-6);
      const cat = String(category || 'GEN').slice(0,3).toUpperCase();
      return `${year}-${cat}-${rank}-${tsShort}`;
    }

    // draw function: absolute positions based on A4 2480x3508 px
    function drawCertificateCanvas(ctx, bgImage, opts){
      // clear canvas
      ctx.clearRect(0,0, CANVAS_W, CANVAS_H);
      // draw background image covering whole A4
      ctx.drawImage(bgImage, 0, 0, CANVAS_W, CANVAS_H);

      // apply text stylings to match image
      // We'll use Playfair Display + Great Vibes + Lora
      // Helper to draw SVG images (medal/flag) via Blob -> Image
      function drawSvgString(svgString, dx, dy, dw, dh){
        return new Promise((resolve)=>{
          if(!svgString){ resolve(); return; }
          const blob = new Blob([svgString], {type:'image/svg+xml;charset=utf-8'});
          const url = URL.createObjectURL(blob);
          const im = new Image();
          im.onload = ()=>{
            ctx.drawImage(im, dx, dy, dw, dh);
            URL.revokeObjectURL(url);
            resolve();
          };
          im.onerror = ()=> { URL.revokeObjectURL(url); resolve(); };
          im.src = url;
        });
      }

      // We'll sequentially draw. Many positions measured by visual matching to your sample.
      // TOP AREA: Title "CERTIFICATE" large centered near top
      ctx.textAlign = 'center';
      ctx.fillStyle = '#0b3b66';

      // CERTIFICATE - large
      ctx.font = 'bold 160px "Playfair Display", serif';
      ctx.fillText('CERTIFICATE', CANVAS_W/2, 410);

      // Subheading lines
      ctx.font = '600 34px "Lora", serif';
      ctx.fillText('OF International Academic', CANVAS_W/2, 480);
      ctx.fillText('Research Competition 2024', CANVAS_W/2, 520);

      // Awarded to small
      ctx.font = '600 28px "Lora", serif';
      ctx.fillStyle = '#333';
      ctx.fillText('Awarded to', CANVAS_W/2, 600);

      // NAME (big cursive) - Great Vibes, exact weight to match image
      ctx.font = 'normal 160px "Great Vibes", cursive';
      ctx.fillStyle = '#0b2e48';
      ctx.fillText(opts.student.name, CANVAS_W/2, 760);

      // big ornamental underline — draw decorative line (simple)
      ctx.strokeStyle = 'rgba(11,59,102,0.12)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(CANVAS_W*0.18, 790);
      ctx.lineTo(CANVAS_W*0.82, 790);
      ctx.stroke();

      // "Of" and school / location
      ctx.font = 'italic 38px "Lora", serif';
      ctx.fillStyle = '#222';
      ctx.fillText('Of', CANVAS_W/2, 860);

      ctx.font = '700 36px "Lora", serif';
      ctx.fillText(`${opts.student.class || ''} at ${opts.student.school}`, CANVAS_W/2, 920);

      ctx.font = 'normal 30px "Lora", serif';
      ctx.fillText(`${opts.student.country}`, CANVAS_W/2, 960);

      // descriptive paragraph (center)
      ctx.font = 'normal 28px "Lora", serif';
      ctx.fillStyle = '#262626';
      const para = `delivering an impressive research project and presentation, and achieved ${opts.rank}th place in the ${opts.student.category || 'Junior'} Category with a score of ${opts.student.scaledFinalScore || (opts.student.researchPaperScore + opts.student.presentationScore)} out of 200`;
      wrapText(ctx, para, CANVAS_W/2, 1060, CANVAS_W*0.70, 36);

      // scores inline (left aligned block)
      ctx.textAlign = 'left';
      ctx.font = '700 30px "Lora", serif';
      ctx.fillStyle = '#072b4a';
      const leftX = CANVAS_W*0.18;
      let baseY = 1220;
      ctx.fillText('Research Proposal:', leftX, baseY);
      ctx.fillStyle = '#222';
      ctx.font = '600 30px "Lora", serif';
      ctx.fillText(`${opts.student.researchPaperScore || 0}/100`, leftX + 360, baseY);

      ctx.fillStyle = '#072b4a';
      ctx.font = '700 30px "Lora", serif';
      ctx.fillText('Presentation:', leftX, baseY + 48);
      ctx.fillStyle = '#222';
      ctx.font = '600 30px "Lora", serif';
      ctx.fillText(`${opts.student.presentationScore || 0}/100`, leftX + 360, baseY + 48);

      ctx.fillStyle = '#072b4a';
      ctx.font = '700 30px "Lora", serif';
      ctx.fillText('Total Score:', leftX, baseY + 96);
      ctx.fillStyle = '#222';
      ctx.font = '700 30px "Lora", serif';
      const totalScore = opts.student.scaledFinalScore || (opts.student.researchPaperScore + opts.student.presentationScore);
      ctx.fillText(`${totalScore}`, leftX + 360, baseY + 96);

      // research title centered below
      ctx.textAlign = 'center';
      ctx.font = '700 30px "Playfair Display", serif';
      ctx.fillStyle = '#072b4a';
      ctx.fillText('Research Title:', CANVAS_W/2, baseY + 210);

      ctx.font = '600 26px "Lora", serif';
      wrapText(ctx, opts.student.research_proposal_title || opts.student.research_proposal_title || '—', CANVAS_W/2, baseY + 250, CANVAS_W*0.72, 34);

      // rank link (small)
      ctx.font = '20px "Lora", serif';
      ctx.fillStyle = '#1b3b56';
      const rankLink = `https://iarco.org/${opts.student.year || 2025}-winners?category=${encodeURIComponent(opts.student.category||'All')}&rank=${opts.rank}`;
      ctx.fillText(rankLink, CANVAS_W/2, CANVAS_H*0.72);

      // big badge star with Top X out of Y - we will draw a centered green badge
      // draw star-like badge (simple polygon) then text in it
      const bx = CANVAS_W/2;
      const by = CANVAS_H*0.78;
      const br = 120;
      drawBadge(ctx, bx, by, br, '#9bb17a');

      ctx.font = '700 40px "Playfair Display", serif';
      ctx.fillStyle = '#0b3b66';
      ctx.fillText(`Top ${opts.rank}th`, bx, by + 8);
      ctx.font = '600 28px "Lora", serif';
      ctx.fillText(`out of ${opts.totalParticipants}`, bx, by + 58);

      // date centered under badge
      ctx.font = '700 34px "Lora", serif';
      ctx.fillText(opts.dateStr, CANVAS_W/2, by + 140);

      // signatures: left and right lower
      const sigY = CANVAS_H*0.88;
      // left signature line (simulate)
      ctx.strokeStyle = '#111';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(CANVAS_W*0.16, sigY);
      ctx.lineTo(CANVAS_W*0.36, sigY);
      ctx.stroke();
      ctx.font = '700 22px "Lora", serif';
      ctx.fillStyle = '#111';
      ctx.fillText('Md. Azmam Yakin Srizon', CANVAS_W*0.16 + (CANVAS_W*0.20)/2, sigY + 34);
      ctx.font = '16px "Lora", serif';
      ctx.fillText('Assistant Professor CSE, RUET', CANVAS_W*0.16 + (CANVAS_W*0.20)/2, sigY + 56);

      // right signature
      ctx.beginPath();
      ctx.moveTo(CANVAS_W*0.64, sigY);
      ctx.lineTo(CANVAS_W*0.84, sigY);
      ctx.stroke();
      ctx.font = '700 22px "Lora", serif';
      ctx.fillText('Md Sanaul Haque Shanto', CANVAS_W*0.64 + (CANVAS_W*0.20)/2, sigY + 34);
      ctx.font = '16px "Lora", serif';
      ctx.fillText('President & Lead Researcher, YRJ', CANVAS_W*0.64 + (CANVAS_W*0.20)/2, sigY + 56);

      // certificate ID left vertically (copying sample)
      ctx.save();
      ctx.translate(60, CANVAS_H*0.55);
      ctx.rotate(-Math.PI/2);
      ctx.font = '14px "Lora", serif';
      ctx.fillStyle = '#333';
      ctx.fillText(`Certification ID: ${opts.certId}`, 0, 0);
      ctx.restore();

      // medal svg above name area at top center
      // approximate position above the "CERTIFICATE" word - we'll place it in the center-top
      const medalW = 220;
      const medalH = 220;
      const medalX = (CANVAS_W - medalW)/2;
      const medalY = 230;
      // draw medal
      // since drawSvgString returns Promise, we simply synchronously draw by creating image via blob
      // But here we will directly draw using the helper and wait (synchronously via Promise.all in caller if needed)
      // For simplicity (synchronous), convert svg string to image and draw (but using onload is asynchronous).
      // We'll instead draw medal synchronously by creating an offscreen image and using onload - but since this function is synchronous,
      // we'll perform a blocking approach by creating an Image and using a temporary canvas - instead, simply draw the SVG via URL and hope it's quick.
      // Use immediate drawing via drawSvgString with small await pattern not available here; but we will approximate by writing the blob now:
      // (NOTE: To ensure medal appears in final PDF preview, the main caller uses the canvas toDataURL AFTER this function completes, and browsers load images async.
      // To guarantee medal and flag are drawn reliably, you could rewrite to return a Promise and await the drawSvg operations. For now, we'll attempt to draw medal and flag via immediate approach.)
      // We'll implement synchronous helper that draws svg via Image and blocks via a Promise in the caller.
      // (In our usage we will actually call drawCertificateCanvas inside an async context and await drawSvgString for medal/flag.)
    } // drawCertificateCanvas end

    // However drawCertificateCanvas used above must support async svg drawing. Let's create an async wrapper that handles svg draw ops, re-drawing main content.
    // To keep code structured, we create drawCertificate which awaits svg draws and then calls drawCertificateCanvasComplete to handle text & shapes.
    async function drawCertificateCanvas(ctx, bgImage, opts){
      // We will first draw background and shapes (static), then draw medal and flag via await drawSvgString
      ctx.clearRect(0,0,CANVAS_W,CANVAS_H);
      ctx.drawImage(bgImage, 0, 0, CANVAS_W, CANVAS_H);

      // static text & shapes (call separate synchronous function)
      drawStaticElements(ctx, opts);

      // draw medal svg centered top (above header) - async
      if(opts.medalSvg){
        const medalW = 240, medalH = 240;
        const medalX = (CANVAS_W - medalW)/2;
        const medalY = 220;
        await drawSvgStringToCtx(ctx, opts.medalSvg, medalX, medalY, medalW, medalH);
      }

      // draw flag bottom-right near date area
      if(opts.flagSvg){
        const fw = 220, fh = 132;
        const fx = CANVAS_W - fw - 120;
        const fy = CANVAS_H - fh - 230;
        await drawSvgStringToCtx(ctx, opts.flagSvg, fx, fy, fw, fh);
      }

      // all done
    }

    // helper to convert svg string to image draw on given ctx - returns Promise
    function drawSvgStringToCtx(ctx, svgString, dx, dy, dw, dh){
      return new Promise((res)=>{
        if(!svgString){ res(); return; }
        const blob = new Blob([svgString], {type:'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const im = new Image();
        im.onload = ()=>{
          ctx.drawImage(im, dx, dy, dw, dh);
          URL.revokeObjectURL(url);
          res();
        };
        im.onerror = ()=>{
          URL.revokeObjectURL(url);
          res();
        };
        im.src = url;
      });
    }

    // separate function to draw the static elements (text shapes) synchronously
    function drawStaticElements(ctx, opts){
      // replicate the static text & shapes portion from earlier (so we can call it synchronously)
      ctx.textAlign = 'center';
      ctx.fillStyle = '#0b3b66';
      ctx.font = 'bold 160px "Playfair Display", serif';
      ctx.fillText('CERTIFICATE', CANVAS_W/2, 410);

      ctx.font = '600 34px "Lora", serif';
      ctx.fillText('OF International Academic', CANVAS_W/2, 480);
      ctx.fillText('Research Competition 2024', CANVAS_W/2, 520);

      ctx.font = '600 28px "Lora", serif';
      ctx.fillStyle = '#333';
      ctx.fillText('Awarded to', CANVAS_W/2, 600);

      ctx.font = 'normal 160px "Great Vibes", cursive';
      ctx.fillStyle = '#0b2e48';
      ctx.fillText(opts.student.name, CANVAS_W/2, 760);

      ctx.strokeStyle = 'rgba(11,59,102,0.12)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(CANVAS_W*0.18, 790);
      ctx.lineTo(CANVAS_W*0.82, 790);
      ctx.stroke();

      ctx.font = 'italic 38px "Lora", serif';
      ctx.fillStyle = '#222';
      ctx.fillText('Of', CANVAS_W/2, 860);

      ctx.font = '700 36px "Lora", serif';
      ctx.fillText(`${opts.student.class || ''} at ${opts.student.school}`, CANVAS_W/2, 920);

      ctx.font = 'normal 30px "Lora", serif';
      ctx.fillText(`${opts.student.country}`, CANVAS_W/2, 960);

      ctx.font = 'normal 28px "Lora", serif';
      ctx.fillStyle = '#262626';
      const para = `delivering an impressive research project and presentation, and achieved ${opts.rank}th place in the ${opts.student.category || 'Junior'} Category with a score of ${opts.student.scaledFinalScore || (opts.student.researchPaperScore + opts.student.presentationScore)} out of 200`;
      wrapText(ctx, para, CANVAS_W/2, 1060, CANVAS_W*0.70, 36);

      ctx.textAlign = 'left';
      ctx.font = '700 30px "Lora", serif';
      ctx.fillStyle = '#072b4a';
      const leftX = CANVAS_W*0.18;
      let baseY = 1220;
      ctx.fillText('Research Proposal:', leftX, baseY);
      ctx.fillStyle = '#222';
      ctx.font = '600 30px "Lora", serif';
      ctx.fillText(`${opts.student.researchPaperScore || 0}/100`, leftX + 360, baseY);

      ctx.fillStyle = '#072b4a';
      ctx.font = '700 30px "Lora", serif';
      ctx.fillText('Presentation:', leftX, baseY + 48);
      ctx.fillStyle = '#222';
      ctx.font = '600 30px "Lora", serif';
      ctx.fillText(`${opts.student.presentationScore || 0}/100`, leftX + 360, baseY + 48);

      ctx.fillStyle = '#072b4a';
      ctx.font = '700 30px "Lora", serif';
      ctx.fillText('Total Score:', leftX, baseY + 96);
      ctx.fillStyle = '#222';
      ctx.font = '700 30px "Lora", serif';
      const totalScore = opts.student.scaledFinalScore || (opts.student.researchPaperScore + opts.student.presentationScore);
      ctx.fillText(`${totalScore}`, leftX + 360, baseY + 96);

      ctx.textAlign = 'center';
      ctx.font = '700 30px "Playfair Display", serif';
      ctx.fillStyle = '#072b4a';
      ctx.fillText('Research Title:', CANVAS_W/2, baseY + 210);

      ctx.font = '600 26px "Lora", serif';
      wrapText(ctx, opts.student.research_proposal_title || opts.student.research_proposal_title || '—', CANVAS_W/2, baseY + 250, CANVAS_W*0.72, 34);

      ctx.font = '20px "Lora", serif';
      ctx.fillStyle = '#1b3b56';
      const rankLink = `https://iarco.org/${opts.student.year || 2025}-winners?category=${encodeURIComponent(opts.student.category||'All')}&rank=${opts.rank}`;
      ctx.fillText(rankLink, CANVAS_W/2, CANVAS_H*0.72);

      // badge:
      const bx = CANVAS_W/2;
      const by = CANVAS_H*0.78;
      const br = 120;
      drawBadge(ctx, bx, by, br, '#9bb17a');

      ctx.font = '700 40px "Playfair Display", serif';
      ctx.fillStyle = '#0b3b66';
      ctx.fillText(`Top ${opts.rank}th`, bx, by + 8);
      ctx.font = '600 28px "Lora", serif';
      ctx.fillText(`out of ${opts.totalParticipants}`, bx, by + 58);

      ctx.font = '700 34px "Lora", serif';
      ctx.fillText(opts.dateStr, CANVAS_W/2, by + 140);

      // signatures
      const sigY = CANVAS_H*0.88;
      ctx.strokeStyle = '#111';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(CANVAS_W*0.16, sigY);
      ctx.lineTo(CANVAS_W*0.36, sigY);
      ctx.stroke();
      ctx.font = '700 22px "Lora", serif';
      ctx.fillStyle = '#111';
      ctx.fillText('Md. Azmam Yakin Srizon', CANVAS_W*0.16 + (CANVAS_W*0.20)/2, sigY + 34);
      ctx.font = '16px "Lora", serif';
      ctx.fillText('Assistant Professor CSE, RUET', CANVAS_W*0.16 + (CANVAS_W*0.20)/2, sigY + 56);

      ctx.beginPath();
      ctx.moveTo(CANVAS_W*0.64, sigY);
      ctx.lineTo(CANVAS_W*0.84, sigY);
      ctx.stroke();
      ctx.font = '700 22px "Lora", serif';
      ctx.fillText('Md Sanaul Haque Shanto', CANVAS_W*0.64 + (CANVAS_W*0.20)/2, sigY + 34);
      ctx.font = '16px "Lora", serif';
      ctx.fillText('President & Lead Researcher, YRJ', CANVAS_W*0.64 + (CANVAS_W*0.20)/2, sigY + 56);

      ctx.save();
      ctx.translate(60, CANVAS_H*0.55);
      ctx.rotate(-Math.PI/2);
      ctx.font = '14px "Lora", serif';
      ctx.fillStyle = '#333';
      ctx.fillText(`Certification ID: ${opts.certId}`, 0, 0);
      ctx.restore();
    }

    // draw badge helper (star-like)
    function drawBadge(ctx, cx, cy, r, color){
      // draw a simple 12-point rosette
      ctx.fillStyle = color;
      ctx.beginPath();
      const spikes = 12;
      for(let i=0;i<spikes;i++){
        const ang = (i/spikes) * Math.PI*2;
        const rx = cx + Math.cos(ang) * r;
        const ry = cy + Math.sin(ang) * (r*0.7);
        if(i===0) ctx.moveTo(rx,ry); else ctx.lineTo(rx,ry);
      }
      ctx.closePath();
      ctx.fill();

      // center circle
      ctx.fillStyle = '#fbf7e6';
      ctx.beginPath();
      ctx.arc(cx, cy, r*0.5, 0, Math.PI*2);
      ctx.fill();
    }

    // simple wrap text centered
    function wrapText(ctx, text, x, y, maxWidth, lineHeight){
      const words = text.split(' ');
      let line = '';
      let testY = y;
      ctx.textAlign = 'center';
      for(let n=0;n<words.length;n++){
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        if(metrics.width > maxWidth && n > 0){
          ctx.fillText(line, x, testY);
          line = words[n] + ' ';
          testY += lineHeight;
        } else {
          line = testLine;
        }
      }
      ctx.fillText(line, x, testY);
    }

    // convert canvas to PDF (A4 mm size) and trigger download
    async function canvasToPdfAndDownload(canvas, filename){
      const { jsPDF } = window.jspdf;
      // create a blob from canvas
      const dataURL = canvas.toDataURL('image/png', 1.0);
      // create jsPDF
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      });
      // A4 size in mm
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      // place image to fill page (respect aspect ratio)
      // compute dims
      const img = new Image();
      img.src = dataURL;
      await new Promise((res)=> img.onload = res);
      const imgW = img.width;
      const imgH = img.height;
      const ratio = Math.min(pageW / imgW * 25.4, pageH / imgH * 25.4); // conversion approx (px->mm) we will fit with simple approach
      // Better approach: compute ratio using DPI assumption: if canvas px correspond to 2480x3508 for A4, then px -> mm scale is px / mm = 2480 / 210
      const pxPerMmX = CANVAS_W / 210; // px per mm
      const drawW = imgW / pxPerMmX;
      const drawH = imgH / pxPerMmX;
      const x = (pageW - drawW)/2;
      const y = (pageH - drawH)/2;
      pdf.addImage(dataURL, 'PNG', x, y, drawW, drawH, undefined, 'FAST');
      // save
      pdf.save(filename);
    }

    // overlay show/hide
    function showOverlay(){
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');
      bar.style.width = '6%';
      setTimeout(()=> bar.style.width = '42%', 300);
      setTimeout(()=> bar.style.width = '72%', 900);
      setTimeout(()=> bar.style.width = '92%', 1700);
    }
    function hideOverlay(){
      bar.style.width = '100%';
      setTimeout(()=> { overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); bar.style.width = '0%'; }, 700);
    }

    // download last
    downloadLastBtn.addEventListener('click', ()=>{
      if(!lastStudent){
        alert('No certificate generated yet.');
        return;
      }
      // regenerate for lastStudent quickly (this will overwrite)
      startGenerate(lastStudent);
    });

    // expose render utility for convenient testing
    window.__debug_render_all = ()=> renderResults(students);

    // auto-load demo
    renderResults(students);

  })();
  </script>
</body>
</html>
