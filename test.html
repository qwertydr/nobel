<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IARCO 2025 Certificate Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --gold: #D4AF37;
            --blue: #1E3A8A;
            --light-blue: #3B82F6;
            --white: #FFFFFF;
            --gray: #F3F4F6;
            --dark-gray: #6B7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--blue) 0%, var(--light-blue) 100%);
            color: var(--white);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--gold);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }

        .search-section {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: fit-content;
        }

        .search-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            width: 100%;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            color: var(--blue);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }

        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            color: var(--blue);
        }

        .search-result-item:hover {
            background: #f5f5f5;
        }

        button {
            background: var(--gold);
            color: var(--blue);
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        button:hover {
            background: #E6C158;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .student-details {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: none;
        }

        .student-info {
            margin-bottom: 15px;
        }

        .student-info h3 {
            color: var(--gold);
            margin-bottom: 10px;
        }

        .student-info p {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .flag-icon {
            width: 20px;
            height: 14px;
            display: inline-block;
        }

        .certificate-section {
            flex: 2;
            min-width: 300px;
        }

        .certificate-container {
            position: relative;
        }

        .certificate-wrapper {
            position: relative;
            width: 100%;
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            background-color: white;
            aspect-ratio: 1.414 / 1; /* A4 ratio */
        }

        .certificate-template {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #fff;
            color: #000;
            padding: 50px;
            box-sizing: border-box;
            font-family: 'Times New Roman', Times, serif;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect x="0" y="0" width="100" height="100" fill="none" stroke="%23D4AF37" stroke-width="1" stroke-dasharray="5,5"/></svg>');
            background-size: 100px 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .certificate-border {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            border: 3px solid var(--gold);
            pointer-events: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 30px 0;
        }

        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid var(--gold);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-results {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .certificate-template {
                padding: 30px;
            }
        }

        /* Certificate specific styles */
        .cert-title {
            text-align: center;
            margin-bottom: 10px;
        }

        .cert-title h1 {
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #000;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .cert-subtitle {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #000;
        }

        .cert-year {
            font-size: 16px;
            color: #000;
            font-weight: 500;
        }

        .cert-body {
            text-align: center;
            margin-bottom: 10px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .awarded-to {
            font-size: 18px;
            color: #000;
            margin-bottom: 10px;
        }

        .student-name-cert {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #000;
        }

        .divider {
            width: 80%;
            height: 1px;
            background-color: #000;
            margin: 0 auto 20px;
        }

        .location-info {
            font-size: 18px;
            color: #000;
            margin-bottom: 20px;
        }

        .performance-text {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 20px;
            color: #000;
        }

        .research-title {
            font-size: 16px;
            font-weight: bold;
            font-style: italic;
            margin-bottom: 20px;
            color: #000;
        }

        .rank-link {
            font-size: 14px;
            margin-bottom: 20px;
            color: #000;
        }

        .rank-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .rank-text {
            font-size: 20px;
            font-weight: bold;
            color: #000;
        }

        .medal-icon {
            width: 50px;
            height: 50px;
        }

        .total-participants {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #000;
        }

        .cert-date {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #000;
            text-align: center;
        }

        .signatures {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .signature {
            text-align: center;
        }

        .signature-line {
            width: 150px;
            height: 1px;
            background-color: #000;
            margin: 0 auto 5px;
        }

        .signature-name {
            font-size: 14px;
            font-weight: bold;
            color: #000;
        }

        .signature-title {
            font-size: 12px;
            color: #000;
        }

        .footer {
            text-align: center;
        }

        .powered-by {
            font-size: 12px;
            color: #000;
        }

        .certificate-id {
            font-size: 10px;
            margin-top: 5px;
            color: #000;
        }

        .year-selector {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>IARCO Certificate Generator</h1>
            <p class="subtitle">Generate your International Academic Research Competition certificate</p>
        </header>

        <div class="main-content">
            <section class="search-section">
                <form class="search-form" id="searchForm">
                    <div class="form-group year-selector">
                        <label for="certYearSelect">Certificate Year</label>
                        <select id="certYearSelect">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="studentName">Search Student Name</label>
                        <input type="text" id="studentName" placeholder="Enter student name" autocomplete="off">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                </form>

                <div class="student-details" id="studentDetails">
                    <div class="student-info">
                        <h3>Student Information</h3>
                        <p><strong>Name:</strong> <span id="detailName"></span></p>
                        <p><strong>School:</strong> <span id="detailSchool"></span></p>
                        <p><strong>Class:</strong> <span id="detailClass"></span></p>
                        <p><strong>Category:</strong> <span id="detailCategory"></span></p>
                        <p><strong>Country:</strong> <span id="detailCountry"></span> <span class="flag-icon" id="detailFlag"></span></p>
                        <p><strong>Research Title:</strong> <span id="detailResearchTitle"></span></p>
                    </div>
                    <div class="student-info">
                        <h3>Performance Details</h3>
                        <p><strong>Research Proposal Score:</strong> <span id="detailProposalScore"></span>/100</p>
                        <p><strong>Presentation Score:</strong> <span id="detailPresentationScore"></span>/100</p>
                        <p><strong>Total Score:</strong> <span id="detailTotalScore"></span>/200</p>
                        <p><strong>Rank:</strong> <span id="detailRank"></span></p>
                    </div>
                    <button id="generateBtn">
                        <span>Generate Certificate</span>
                    </button>
                </div>

                <div class="no-results" id="noResults">
                    <p>No student found with that name. Please check the spelling and try again.</p>
                </div>
            </section>

            <section class="certificate-section">
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p>Generating your certificate...</p>
                </div>

                <div class="certificate-container" id="certificateContainer" style="display: none;">
                    <div class="certificate-wrapper">
                        <div class="certificate-template">
                            <div class="certificate-border"></div>
                            
                            <div class="cert-title">
                                <h1>CERTIFICATE</h1>
                                <p class="cert-subtitle">OF International Academic Research Competition</p>
                                <p class="cert-year" id="certYear">2025</p>
                            </div>

                            <div class="cert-body">
                                <p class="awarded-to">Awarded to</p>
                                <h2 class="student-name-cert" id="displayName">Student Name</h2>
                                
                                <div class="divider"></div>
                                
                                <div class="location-info">
                                    <p>Of</p>
                                    <p id="displayClassSchool">Class at School</p>
                                    <p id="displayLocation">Location, Country</p>
                                </div>

                                <p class="performance-text">
                                    delivering an impressive research project and presentation, and achieved
                                    <span style="font-weight: bold;" id="displayRank">Xth</span> place in the 
                                    <span style="font-weight: bold;" id="displayCategory">Category</span> Category with a score of 
                                    <span style="font-weight: bold;" id="displayTotalScore">XXX</span> out of 200
                                    (Research Proposal: <span style="font-weight: bold;" id="displayProposalScore">XX</span>/100, 
                                    Presentation: <span style="font-weight: bold;" id="displayPresentationScore">XX</span>/100).
                                </p>

                                <p class="research-title">
                                    Research Title: <span id="researchTitle">Research Title Here</span>
                                </p>

                                <p class="rank-link" id="rankLink">
                                    https://iarco.org/2025-winners?category=Junior&rank=X
                                </p>

                                <div class="rank-badge">
                                    <span class="rank-text">Top <span id="badgeRank">X</span></span>
                                    <img src="" alt="Medal" class="medal-icon" id="medalIcon">
                                </div>
                                <p class="total-participants">out of <span id="totalParticipants">XX</span></p>
                            </div>

                            <div class="cert-date">
                                <p>December 30, <span id="certYearFooter">2025</span></p>
                            </div>

                            <div class="signatures">
                                <div class="signature">
                                    <div class="signature-line"></div>
                                    <p class="signature-name">Md. Azmann Yakin Srizon</p>
                                    <p class="signature-title">Assistant Professor CSE, RUET</p>
                                    <p class="signature-title">Reviewer, IEEE Access</p>
                                </div>
                                <div class="signature">
                                    <div class="signature-line"></div>
                                    <p class="signature-name">Md Sanaul Haque Shanto</p>
                                    <p class="signature-title">President & Lead</p>
                                    <p class="signature-title">Researcher, YRJ</p>
                                </div>
                            </div>

                            <div class="footer">
                                <p class="powered-by">Powered by: yjbumal.org</p>
                                <p class="certificate-id">Certificate ID: <span id="certificateId">XXXX-XXXX-XXXX</span></p>
                            </div>
                        </div>
                    </div>

                    <div class="actions">
                        <button id="previewBtn">
                            <span>Preview Certificate</span>
                        </button>
                        <button id="downloadBtn">
                            <span>Download PDF</span>
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Sample data - In a real implementation, these would be loaded from external JSON files
        const students = [
            {
                "student_id": "v1MrV4dT",
                "name": "Afia Anjum Aboni",
                "school": "Rajuk Uttara Model College",
                "class": "A Level",
                "category": "Junior",
                "year": 2024,
                "country": "Bangladesh",
                "research_proposal_title": "The Relevance of Class Disparity in the Implementation of Climate-Related Policies; an Investigation into the Different Socioeconomic Classes of Dhaka",
                "researchPaperScore": 78,
                "presentationScore": 68,
                "submissionScore": 146,
                "scaledFinalScore": 131
            },
            {
                "student_id": "LXd6a9ey",
                "name": "Adira Safwan",
                "school": "Maple Leaf International School",
                "class": "A Level",
                "category": "Senior", 
                "year": 2024,
                "country": "Bangladesh",
                "research_proposal_title": "Exploring Differences in Social Media Literacy Between Digital Natives and Digital Immigrants: A Comparative Analysis of Critical Skills and Digital Adaptability",
                "researchPaperScore": 69,
                "presentationScore": 85,
                "submissionScore": 154,
                "scaledFinalScore": 154
            },
            {
                "student_id": "ABC12345",
                "name": "Sarhan Alan Khan",
                "school": "Scholastica",
                "class": "A Level",
                "category": "Junior",
                "year": 2024,
                "country": "Bangladesh",
                "research_proposal_title": "Enhancing IoT Security with Machine Learning for Real-Time Threat Detection",
                "researchPaperScore": 70,
                "presentationScore": 64,
                "submissionScore": 134,
                "scaledFinalScore": 134
            },
            {
                "student_id": "DEF67890",
                "name": "John Smith",
                "school": "International School",
                "class": "A Level",
                "category": "Senior",
                "year": 2025,
                "country": "Canada",
                "research_proposal_title": "AI Applications in Environmental Conservation",
                "researchPaperScore": 85,
                "presentationScore": 90,
                "submissionScore": 175,
                "scaledFinalScore": 175
            }
        ];

        const flags = {
            "Bangladesh": "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 12'><rect width='20' height='12' fill='#006a4e'/><circle cx='8' cy='6' r='3.6' fill='#f42a41'/></svg>",
            "Japan": "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 12'><rect width='20' height='12' fill='#ffffff'/><circle cx='10' cy='6' r='3.6' fill='#bc002d'/></svg>",
            "Canada": "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 12'><rect width='20' height='12' fill='#ff0000'/><rect x='6' width='8' height='12' fill='#ffffff'/><path fill='#ff0000' d='M10 2.2 8.8 3.5h0.7v1.8h0.9V3.5h0.7L10 2.2zm0 6.6-1.4-2.1h0.9v-1h0.9v1h0.9L10 8.8z'/></svg>"
        };

        const certificates = {
            "2024": "certificate/2024.pdf",
            "2025": "certificate/2025.pdf"
        };

        const medals = {
            "gold": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzAiIGZpbGw9IiNEM0E1MzciLz48Y2lyY2xlIGN4PSIzMiIgY3k9IjMyIiByPSIyNSIgZmlsbD0iI0ZGQ0MwMCIvPjx0ZXh0IHg9IjMyIiB5PSIzOCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE4IiBmb250LXdlaWdodD0iYm9sZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzAwMCI+MTwvdGV4dD48L3N2Zz4=",
            "silver": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzAiIGZpbGw9IiNDMEMwQzAiLz48Y2lyY2xlIGN4PSIzIiBjeT0iMzIiIHI9IjI1IiBmaWxsPSIjRTZFNkU2Ii8+PHRleHQgeD0iMzIiIHk9IjM4IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZvbnQtd2VpZ2h0PSJib2xkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjMDAwIj4yPC90ZXh0Pjwvc3ZnPg==",
            "bronze": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PGNpcmNsZSBjeD0iMzIiIGN5PSIzMiIgcj0iMzAiIGZpbGw9IiM4QjQ1MDEiLz48Y2lyY2xlIGN4PSIzMiIgY3k9IjMyIiByPSIyNSIgZmlsbD0iI0NEOTczQyIvPjx0ZXh0IHg9IjMyIiB5PSIzOCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE4IiBmb250LXdlaWdodD0iYm9sZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzAwMCI+MzwvdGV4dD48L3N2Zz4=",
            "honorable": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iOCIgZmlsbD0iIzFFM0E4QSIvPjx0ZXh0IHg9IjMyIiB5PSIzOCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI0ZGRiI+SE9OT1JBQkxFPC90ZXh0Pjx0ZXh0IHg9IjMyIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjRkZGIj5NRU5USU9OPC90ZXh0Pjwvc3ZnPg==",
            "finalist": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iOCIgZmlsbD0iIzNCODJGNiIvPjx0ZXh0IHg9IjMyIiB5PSIzOCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI0ZGRiI+RklOQUxJU1Q8L3RleHQ+PC9zdmc+"
        };

        // DOM elements
        const searchForm = document.getElementById('searchForm');
        const studentNameInput = document.getElementById('studentName');
        const certYearSelect = document.getElementById('certYearSelect');
        const searchResults = document.getElementById('searchResults');
        const studentDetails = document.getElementById('studentDetails');
        const noResults = document.getElementById('noResults');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const certificateContainer = document.getElementById('certificateContainer');
        const generateBtn = document.getElementById('generateBtn');
        const previewBtn = document.getElementById('previewBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        
        // Student detail elements
        const detailName = document.getElementById('detailName');
        const detailSchool = document.getElementById('detailSchool');
        const detailClass = document.getElementById('detailClass');
        const detailCategory = document.getElementById('detailCategory');
        const detailCountry = document.getElementById('detailCountry');
        const detailFlag = document.getElementById('detailFlag');
        const detailResearchTitle = document.getElementById('detailResearchTitle');
        const detailProposalScore = document.getElementById('detailProposalScore');
        const detailPresentationScore = document.getElementById('detailPresentationScore');
        const detailTotalScore = document.getElementById('detailTotalScore');
        const detailRank = document.getElementById('detailRank');
        
        // Certificate display elements
        const certYear = document.getElementById('certYear');
        const certYearFooter = document.getElementById('certYearFooter');
        const displayName = document.getElementById('displayName');
        const displayClassSchool = document.getElementById('displayClassSchool');
        const displayLocation = document.getElementById('displayLocation');
        const displayRank = document.getElementById('displayRank');
        const displayCategory = document.getElementById('displayCategory');
        const displayTotalScore = document.getElementById('displayTotalScore');
        const displayProposalScore = document.getElementById('displayProposalScore');
        const displayPresentationScore = document.getElementById('displayPresentationScore');
        const researchTitle = document.getElementById('researchTitle');
        const rankLink = document.getElementById('rankLink');
        const badgeRank = document.getElementById('badgeRank');
        const totalParticipants = document.getElementById('totalParticipants');
        const medalIcon = document.getElementById('medalIcon');
        const certificateId = document.getElementById('certificateId');

        // Currently selected student
        let currentStudent = null;
        let currentYear = "2025";

        // Function to calculate ranks per category and year
        function calculateRanks(students) {
            // Group students by category and year
            const grouped = {};
            
            students.forEach(student => {
                const key = `${student.category}-${student.year}`;
                if (!grouped[key]) {
                    grouped[key] = [];
                }
                grouped[key].push(student);
            });
            
            // Sort each group by scaledFinalScore and assign ranks
            Object.keys(grouped).forEach(key => {
                grouped[key].sort((a, b) => b.scaledFinalScore - a.scaledFinalScore);
                grouped[key].forEach((student, index) => {
                    student.rank = index + 1;
                    student.totalInCategory = grouped[key].length;
                });
            });
            
            return students;
        }

        // Get medal based on rank
        function getMedal(rank) {
            if (rank === 1) return medals.gold;
            if (rank === 2) return medals.silver;
            if (rank === 3) return medals.bronze;
            if (rank >= 4 && rank <= 10) return medals.honorable;
            return medals.finalist;
        }

        // Format rank text (1st, 2nd, 3rd, etc.)
        function formatRank(rank) {
            if (rank === 1) return '1st';
            if (rank === 2) return '2nd';
            if (rank === 3) return '3rd';
            return `${rank}th`;
        }

        // Find student data by name (word by word search)
        function findStudentsByName(name) {
            if (!name) return [];
            
            const searchTerms = name.toLowerCase().split(' ');
            return students.filter(student => {
                const studentName = student.name.toLowerCase();
                return searchTerms.every(term => studentName.includes(term));
            });
        }

        // Display search results
        function displaySearchResults(results) {
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                searchResults.style.display = 'none';
                return;
            }
            
            results.forEach(student => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.textContent = `${student.name} (${student.category}, ${student.year})`;
                item.addEventListener('click', () => {
                    selectStudent(student);
                });
                searchResults.appendChild(item);
            });
            
            searchResults.style.display = 'block';
        }

        // Select a student from search results
        function selectStudent(student) {
            currentStudent = student;
            studentNameInput.value = student.name;
            searchResults.style.display = 'none';
            displayStudentDetails(student);
        }

        // Display student details
        function displayStudentDetails(student) {
            detailName.textContent = student.name;
            detailSchool.textContent = student.school;
            detailClass.textContent = student.class;
            detailCategory.textContent = student.category;
            detailCountry.textContent = student.country;
            detailResearchTitle.textContent = student.research_proposal_title;
            detailProposalScore.textContent = student.researchPaperScore;
            detailPresentationScore.textContent = student.presentationScore;
            detailTotalScore.textContent = student.scaledFinalScore;
            detailRank.textContent = formatRank(student.rank);
            
            // Set flag
            if (flags[student.country]) {
                detailFlag.innerHTML = flags[student.country];
            }
            
            studentDetails.style.display = 'block';
            noResults.style.display = 'none';
        }

        // Generate certificate
        function generateCertificate(student, year) {
            // Calculate ranks
            calculateRanks(students);
            
            // Set certificate content
            certYear.textContent = year;
            certYearFooter.textContent = year;
            displayName.textContent = student.name;
            displayClassSchool.textContent = `${student.class} at ${student.school}`;
            displayLocation.textContent = `Dhaka, ${student.country}`;
            
            // Set performance details
            const formattedRank = formatRank(student.rank);
            displayRank.textContent = formattedRank;
            displayCategory.textContent = student.category;
            displayTotalScore.textContent = student.scaledFinalScore;
            displayProposalScore.textContent = student.researchPaperScore;
            displayPresentationScore.textContent = student.presentationScore;
            
            researchTitle.textContent = student.research_proposal_title;
            
            rankLink.textContent = `https://iarco.org/${year}-winners?category=${student.category}&rank=${student.rank}`;
            
            badgeRank.textContent = formattedRank;
            totalParticipants.textContent = student.totalInCategory;
            
            // Set medal
            medalIcon.src = getMedal(student.rank);
            
            // Set certificate ID (using student_id)
            certificateId.textContent = student.student_id;
            
            // Show certificate
            certificateContainer.style.display = 'block';
        }

        // Show loading indicator
        function showLoading() {
            loadingIndicator.style.display = 'block';
        }

        // Hide loading indicator
        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }

        // Download PDF
        function downloadPDF() {
            if (!currentStudent) {
                alert('Please select a student first');
                return;
            }
            
            showLoading();
            
            // Use a timeout to ensure the certificate is fully rendered
            setTimeout(() => {
                const element = document.querySelector('.certificate-wrapper');
                const opt = {
                    margin: 0,
                    filename: `IARCO_${currentYear}_Certificate_${currentStudent.name.replace(/\s+/g, '_')}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2, 
                        useCORS: true,
                        logging: false,
                        letterRendering: true,
                        width: 794, // A4 width in pixels at 96 DPI
                        height: 1123 // A4 height in pixels at 96 DPI
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait'
                    }
                };
                
                // Generate PDF
                html2pdf().set(opt).from(element).save().then(() => {
                    hideLoading();
                }).catch(err => {
                    console.error('PDF generation error:', err);
                    hideLoading();
                    alert('Error generating PDF. Please try again.');
                });
            }, 500);
        }

        // Event listeners
        studentNameInput.addEventListener('input', function() {
            const name = studentNameInput.value.trim();
            
            if (name.length < 2) {
                searchResults.style.display = 'none';
                studentDetails.style.display = 'none';
                certificateContainer.style.display = 'none';
                return;
            }
            
            const results = findStudentsByName(name);
            displaySearchResults(results);
        });

        certYearSelect.addEventListener('change', function() {
            currentYear = this.value;
            if (currentStudent) {
                generateCertificate(currentStudent, currentYear);
            }
        });

        document.addEventListener('click', function(e) {
            if (!searchResults.contains(e.target) && e.target !== studentNameInput) {
                searchResults.style.display = 'none';
            }
        });

        generateBtn.addEventListener('click', function() {
            if (currentStudent) {
                generateCertificate(currentStudent, currentYear);
            } else {
                alert('Please select a student first');
            }
        });

        previewBtn.addEventListener('click', function() {
            if (currentStudent) {
                generateCertificate(currentStudent, currentYear);
                // Scroll to certificate
                document.querySelector('.certificate-section').scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('Please select a student first');
            }
        });

        downloadBtn.addEventListener('click', downloadPDF);

        // Initialize with sample data for demonstration
        window.addEventListener('DOMContentLoaded', function() {
            // Calculate initial ranks
            calculateRanks(students);
        });
    </script>
</body>
</html>
